@page "/quiz/start"
@using CineQuizAI.Application.Abstractions.ExternalServices
@using CineQuizAI.Application.Features.Quiz.Commands
@using CineQuizAI.Application.Features.Quiz.Handlers
@using CineQuizAI.Application.Features.UserPreferences.Handlers
@using CineQuizAI.Application.Features.UserPreferences.Queries
@using CineQuizAI.Domain.Enums
@using CineQuizAI.Infrastructure.Identity
@using CineQuizAI.Web.Localization.JsonLocalization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject ITmdbClient TmdbClient
@inject StartQuizHandler StartQuizHandler
@inject GetUserPreferenceHandler PreferenceHandler
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJsonStringLocalizerFactory L
@rendermode InteractiveServer

<PageTitle>@S["PageTitle"]</PageTitle>

<div class="container mt-5">
    <h1 class="mb-4">@S["Title"]</h1>

    @if (_isStarting)
    {
     <!-- Loading Modal/Overlay -->
        <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
    <div class="modal-body text-center p-5">
   <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">@S["Loading"]</span>
    </div>
                <h4>@S["GeneratingQuestions"]</h4>
             <p class="text-muted">@S["GeneratingWaitTime"]</p>
 <small class="text-muted">@S.Format("GeneratingForTitle", _selectedTitle?.Title ?? "")</small>
       </div>
                </div>
    </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
         <h5 class="alert-heading">@S["Error"]</h5>
      <p>@_errorMessage</p>
      @if (!string.IsNullOrEmpty(_errorDetails))
     {
                <hr />
      <details>
  <summary>@S["TechnicalDetails"]</summary>
     <pre class="small">@_errorDetails</pre>
            </details>
        }
            <button type="button" class="btn-close" @onclick="() => _errorMessage = string.Empty"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
       <!-- Search Section -->
        <div class="card mb-4">
    <div class="card-header">
 <h5>@S["Step1"]</h5>
     </div>
    <div class="card-body">
     <div class="mb-3">
            <label class="form-label">@S["Category"]</label>
 <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" id="categoryMovie" name="category"
   @onchange="() => _selectedCategory = QuizCategory.Movie" 
     checked="@(_selectedCategory == QuizCategory.Movie)">
           <label class="btn btn-outline-primary" for="categoryMovie">@S["CategoryMovie"]</label>
     
      <input type="radio" class="btn-check" id="categoryTv" name="category"
       @onchange="() => _selectedCategory = QuizCategory.Tv" 
checked="@(_selectedCategory == QuizCategory.Tv)">
      <label class="btn btn-outline-primary" for="categoryTv">@S["CategoryTv"]</label>
  </div>
         </div>

      <div class="input-group mb-3">
       <input type="text" class="form-control" 
    @bind="_searchQuery" 
   @bind:event="oninput" 
            placeholder="@S["SearchPlaceholder"]" />
              <button class="btn btn-primary" type="button" @onclick="SearchTitles" disabled="@_isSearching">
          @if (_isSearching)
          {
        <span class="spinner-border spinner-border-sm me-2"></span>
        }
@S["Search"]
            </button>
    </div>

    <!-- Search Results -->
         @if (_searchResults.Any())
              {
                  <div class="list-group">
                  @foreach (var result in _searchResults)
           {
   <a href="#" class="list-group-item list-group-item-action @(_selectedTitle?.Id == result.Id ? "active" : "")"
  @onclick="() => SelectTitle(result)" @onclick:preventDefault>
      <div class="d-flex w-100 justify-content-between">
        <h6 class="mb-1">@result.Title</h6>
           <small>@result.Year</small>
       </div>
      <p class="mb-1 small">@result.Overview</p>
    </a>
             }
            </div>
            }
    </div>
            </div>

        <!-- Quiz Settings -->
      @if (_selectedTitle is not null)
            {
                <div class="card mb-4">
 <div class="card-header">
     <h5>@S["Step2"]</h5>
         </div>
         <div class="card-body">
            <div class="mb-3">
   <label class="form-label">@S["Difficulty"]</label>
          <select class="form-select" @bind="_selectedDifficulty">
            <option value="@QuizDifficulty.Easy">@S["DifficultyEasy"]</option>
     <option value="@QuizDifficulty.Medium">@S["DifficultyMedium"]</option>
      <option value="@QuizDifficulty.Hard">@S["DifficultyHard"]</option>
  </select>
                 </div>

       <div class="mb-3">
    <label class="form-label">@S["NumberOfQuestions"]</label>
         <select class="form-select" @bind="_questionCount">
 <option value="3">@S.Format("QuestionsCount", 3)</option>
  <option value="5">@S.Format("QuestionsCount", 5)</option>
  <option value="7">@S.Format("QuestionsCount", 7)</option>
       <option value="10">@S.Format("QuestionsCount", 10)</option>
           </select>
      </div>

  <div class="mb-3">
             <label class="form-label">@S["Visibility"]</label>
            <select class="form-select" @bind="_selectedVisibility">
          <option value="@QuizVisibility.Public">@S["VisibilityPublic"]</option>
   <option value="@QuizVisibility.Friends">@S["VisibilityFriends"]</option>
 <option value="@QuizVisibility.Private">@S["VisibilityPrivate"]</option>
     </select>
</div>
   </div>
                </div>

      <button type="button" class="btn btn-success btn-lg w-100" @onclick="BeginQuiz" @onclick:preventDefault disabled="@_isStarting">
              @if (_isStarting)
              {
     <span class="spinner-border spinner-border-sm me-2"></span>
    }
         @S["StartQuiz"]
       </button>
        }
        </div>

     <!-- Preview Panel -->
   <div class="col-md-4">
            @if (_selectedTitle is not null)
    {
      <div class="card">
       <div class="card-header">
       <h5>@S["SelectedTitle"]</h5>
                </div>
        <div class="card-body">
           @if (!string.IsNullOrEmpty(_selectedTitle.PosterPath))
                {
    <img src="https://image.tmdb.org/t/p/w500@(_selectedTitle.PosterPath)" 
 class="img-fluid rounded mb-3" alt="@_selectedTitle.Title" />
       }
 <h5>@_selectedTitle.Title</h5>
               <p class="text-muted">@_selectedTitle.Year</p>
      <p class="small">@_selectedTitle.Overview</p>
          </div>
                </div>
      }
     </div>
    </div>
</div>

@code {
    private IJsonStringLocalizer S = default!;
    private string _searchQuery = string.Empty;
    private QuizCategory _selectedCategory = QuizCategory.Movie;
    private QuizDifficulty _selectedDifficulty = QuizDifficulty.Medium;
    private QuizVisibility _selectedVisibility = QuizVisibility.Public;
    private int _questionCount = 5;
    private string _languageCode = "sv-SE";

    private bool _isSearching = false;
    private bool _isStarting = false;
    private string _errorMessage = string.Empty;
    private string _errorDetails = string.Empty;

    private List<TmdbSearchResult> _searchResults = new();
    private TmdbSearchResult? _selectedTitle = null;
    private Guid? _userId = null;

    protected override void OnInitialized()
    {
        S = L.Create("StartQuiz");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
         var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
       {
       var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim is not null && Guid.TryParse(userIdClaim.Value, out var userId))
  {
             _userId = userId;
     await LoadUserPreferences(userId);
    }
      }
    }
        catch (Exception ex)
        {
        _errorMessage = S.Format("InitializationError", ex.Message);
            _errorDetails = ex.ToString();
            Console.WriteLine($"OnInitializedAsync error: {ex}");
        }
 }

    private async Task LoadUserPreferences(Guid userId)
    {
        try
        {
       var query = new GetUserPreferenceQuery { UserId = userId };
          var preferences = await PreferenceHandler.HandleAsync(query);

if (preferences is not null)
            {
    _selectedCategory = preferences.DefaultCategory;
    _selectedDifficulty = preferences.DefaultDifficulty;
     _languageCode = preferences.LanguageCode;
         }
       
            // Override language with current culture from cookie if different
            var currentCulture = System.Globalization.CultureInfo.CurrentUICulture.Name;
            var cookieLanguageCode = currentCulture.StartsWith("sv") ? "sv-SE" : "en-US";
     if (_languageCode != cookieLanguageCode)
   {
   _languageCode = cookieLanguageCode;
     }
        }
    catch (Exception ex)
        {
   Console.WriteLine($"Failed to load preferences: {ex.Message}");
     // Don't show error to user, just use defaults
          
     // Fallback to culture from cookie
            var currentCulture = System.Globalization.CultureInfo.CurrentUICulture.Name;
      _languageCode = currentCulture.StartsWith("sv") ? "sv-SE" : "en-US";
 }
    }

    private async Task SearchTitles()
    {
        try
    {
     Console.WriteLine($"SearchTitles called with query: '{_searchQuery}'");

       if (string.IsNullOrWhiteSpace(_searchQuery))
        {
 Console.WriteLine("Search query is empty, returning");
    return;
    }

       _isSearching = true;
            _errorMessage = string.Empty;
 _errorDetails = string.Empty;
            _searchResults.Clear();
            _selectedTitle = null;

        Console.WriteLine($"Calling TMDb API for category: {_selectedCategory}, language: {_languageCode}");

  _searchResults = _selectedCategory == QuizCategory.Movie
                ? await TmdbClient.SearchMoviesAsync(_searchQuery, _languageCode)
      : await TmdbClient.SearchTvSeriesAsync(_searchQuery, _languageCode);

            Console.WriteLine($"Got {_searchResults.Count} results");
   }
        catch (Exception ex)
        {
   Console.WriteLine($"Search failed: {ex.Message}");
       Console.WriteLine($"Stack trace: {ex.StackTrace}");
            _errorMessage = S.Format("SearchFailed", ex.Message);
            _errorDetails = ex.ToString();
        }
        finally
        {
_isSearching = false;
            Console.WriteLine("Search completed");
        }
    }

    private void SelectTitle(TmdbSearchResult title)
    {
    _selectedTitle = title;
        _errorMessage = string.Empty;
        _errorDetails = string.Empty;
        Console.WriteLine($"? Selected title: {title.Title} (ID: {title.Id})");
Console.WriteLine($"   _selectedTitle is now: {(_selectedTitle != null ? "NOT NULL" : "NULL")}");
        Console.WriteLine($"   _userId is: {(_userId != null ? "NOT NULL" : "NULL")}");

        // Force UI update
        StateHasChanged();
    }

    private async Task BeginQuiz()
    {
        Console.WriteLine($"?? BeginQuiz() called!");
        Console.WriteLine($"   _selectedTitle: {(_selectedTitle != null ? _selectedTitle.Title : "NULL")}");
        Console.WriteLine($"   _userId: {(_userId != null ? _userId.ToString() : "NULL")}");

   if (_selectedTitle is null || _userId is null)
        {
            Console.WriteLine($"? Cannot start quiz - missing data!");
            Console.WriteLine($"   _selectedTitle is null: {_selectedTitle is null}");
            Console.WriteLine($"   _userId is null: {_userId is null}");
            return;
        }

        _isStarting = true;
        _errorMessage = string.Empty;
        _errorDetails = string.Empty;
        
   // Force UI update to show modal
        StateHasChanged();

try
   {
 Console.WriteLine($"?? Starting quiz for '{_selectedTitle.Title}' (TMDb ID: {_selectedTitle.Id})");
            
     var command = new StartQuizCommand
            {
       UserId = _userId.Value,
           TmdbId = _selectedTitle.Id,
       TitleType = _selectedCategory == QuizCategory.Movie ? TitleType.Movie : TitleType.Tv,
  Category = _selectedCategory,
         Difficulty = _selectedDifficulty,
    LanguageCode = _languageCode,
        Visibility = _selectedVisibility,
    QuestionCount = _questionCount
            };

            Console.WriteLine($"?? Command created: Difficulty={command.Difficulty}, Questions={command.QuestionCount}");
      
var session = await StartQuizHandler.HandleAsync(command);
            
  Console.WriteLine($"? Quiz session created with ID: {session.Id}");
    Console.WriteLine($"?? Navigating to /quiz/play/{session.Id}");
         
          // Navigate to quiz play page
            Navigation.NavigateTo($"/quiz/play/{session.Id}");
      }
        catch (Exception ex)
        {
    Console.WriteLine($"? Failed to start quiz: {ex.Message}");
    Console.WriteLine($"Stack trace: {ex}");
            _errorMessage = S.Format("StartQuizFailed", ex.Message);
            _errorDetails = ex.ToString();
            _isStarting = false;
   StateHasChanged();
        }
    }
}
