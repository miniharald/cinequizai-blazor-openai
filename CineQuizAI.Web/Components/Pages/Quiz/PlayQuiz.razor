@page "/quiz/play/{SessionId:guid}"
@using CineQuizAI.Application.Features.Quiz.Commands
@using CineQuizAI.Application.Features.Quiz.DTOs
@using CineQuizAI.Application.Features.Quiz.Handlers
@using CineQuizAI.Application.Features.Quiz.Queries
@using CineQuizAI.Web.Localization.JsonLocalization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject GetQuizSessionHandler GetSessionHandler
@inject SubmitAnswerHandler SubmitAnswerHandler
@inject FinishQuizHandler FinishQuizHandler
@inject NavigationManager Navigation
@inject IJsonStringLocalizerFactory L
@rendermode InteractiveServer

<PageTitle>@Q.Format("PageTitle", _session?.Title ?? Q["Loading"])</PageTitle>

<div class="container mt-5">
    @if (_isLoading)
    {
     <div class="text-center">
  <div class="spinner-border" role="status">
        <span class="visually-hidden">@Q["Loading"]</span>
         </div>
    <p class="mt-3">@Q["Loading"]</p>
   </div>
    }
    else if (_session is null)
    {
    <div class="alert alert-danger">
       <h4>@Q["QuizNotFound"]</h4>
            <p>@Q["QuizNotFoundMessage"]</p>
            <a href="/quiz/start" class="btn btn-primary">@Q["StartNewQuiz"]</a>
    </div>
}
    else if (_isFinished)
    {
        <!-- Quiz Results -->
   <div class="text-center">
    <h1 class="mb-4">@Q["QuizComplete"]</h1>
            <div class="card mb-4">
          <div class="card-body">
         @if (!string.IsNullOrEmpty(_session.PosterUrl))
  {
           <img src="@_session.PosterUrl" class="img-fluid rounded mb-3" style="max-height: 300px;" alt="@_session.Title" />
         }
       <h2>@_session.Title</h2>
       <p class="text-muted">@_session.Difficulty - @_session.Category</p>
           
         <div class="my-4">
 <h3 class="display-4">@_totalScore / @(_session.QuestionCount * 10)</h3>
    <p class="lead">@Q.Format("OutOfCorrect", _correctAnswers, _session.QuestionCount)</p>
            <div class="progress" style="height: 30px;">
      <div class="progress-bar @GetScoreColor()" role="progressbar" 
          style="width: @GetScorePercentage()%">
@GetScorePercentage()%
                 </div>
   </div>
           </div>

   <div class="mt-4">
            <a href="/quiz/start" class="btn btn-primary btn-lg me-2">@Q["PlayAgain"]</a>
             <a href="/" class="btn btn-outline-secondary btn-lg">@Q["Home"]</a>
        </div>
         </div>
            </div>
        </div>
    }
    else
    {
        <!-- Quiz In Progress -->
        <div class="row">
          <div class="col-md-8">
         <!-- Question Card -->
         <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
   <h5 class="mb-0">@Q.Format("QuestionOf", _currentQuestionIndex + 1, _session.QuestionCount)</h5>
         <span class="badge bg-primary">@_session.Difficulty</span>
  </div>
           <div class="card-body">
   @if (_currentQuestion is not null)
       {
        <h4 class="mb-4">@_currentQuestion.Text</h4>

         @if (!string.IsNullOrEmpty(_currentQuestion.ImageUrl))
         {
       <img src="@_currentQuestion.ImageUrl" class="img-fluid rounded mb-4" alt="@Q["QuestionImage"]" />
      }

<div class="list-group">
               @for (int i = 0; i < _currentQuestion.Options.Count; i++)
 {
      var index = i;
       var option = _currentQuestion.Options[i];
     var buttonClass = GetOptionButtonClass(index);

 <button class="list-group-item list-group-item-action @buttonClass" 
         @onclick="() => SelectAnswer(index)"
    disabled="@_isSubmitting">
 @option
      </button>
     }
      </div>

                @if (!string.IsNullOrEmpty(_feedbackMessage))
        {
                  <div class="alert @(_lastAnswerCorrect ? "alert-success" : "alert-danger") mt-3">
    @_feedbackMessage
  </div>
         }

            <div class="mt-4">
     @if (_selectedAnswerIndex is not null && !_answerSubmitted)
          {
                <button class="btn btn-primary btn-lg w-100" @onclick="SubmitAnswer" disabled="@_isSubmitting">
              @if (_isSubmitting)
     {
               <span class="spinner-border spinner-border-sm me-2"></span>
   }
       @Q["SubmitAnswer"]
 </button>
         }
  else if (_answerSubmitted)
     {
  <button class="btn btn-success btn-lg w-100" @onclick="NextQuestion">
        @if (_currentQuestionIndex < _session.QuestionCount - 1)
                  {
         <text>@Q["NextQuestion"]</text>
        }
     else
         {
        <text>@Q["FinishQuiz"]</text>
      }
   </button>
      }
       else
        {
     <p class="text-muted">@Q["SelectAnswer"]</p>
 }
       </div>
          }
           </div>
                </div>
          </div>

            <!-- Sidebar -->
    <div class="col-md-4">
   <div class="card mb-3">
      <div class="card-header">
            <h5>@Q["QuizInfo"]</h5>
     </div>
         <div class="card-body">
    @if (!string.IsNullOrEmpty(_session.PosterUrl))
          {
   <img src="@_session.PosterUrl" class="img-fluid rounded mb-3" alt="@_session.Title" />
          }
       <h6>@_session.Title</h6>
   <p class="text-muted small">@_session.Category</p>
    <hr />
        <p><strong>@Q["Difficulty"]:</strong> @_session.Difficulty</p>
         <p><strong>@Q["Questions"]:</strong> @_session.QuestionCount</p>
          <p><strong>@Q["CurrentScore"]:</strong> @_totalScore</p>
   </div>
      </div>

      <!-- Progress -->
      <div class="card">
              <div class="card-header">
 <h5>@Q["Progress"]</h5>
        </div>
         <div class="card-body">
          <div class="mb-2">
     <small>@_answeredCount / @_session.QuestionCount @Q["Answered"]</small>
   </div>
          <div class="progress">
  <div class="progress-bar" role="progressbar" 
     style="width: @((_answeredCount * 100.0 / _session.QuestionCount))%">
               </div>
        </div>

    <div class="mt-3">
     @for (int i = 0; i < _session.QuestionCount; i++)
                 {
   var statusClass = i < _answeredCount ? "bg-success" :
     i == _currentQuestionIndex ? "bg-primary" : "bg-secondary";
                
             <span class="badge @statusClass me-1">@(i + 1)</span>
       }
          </div>
      </div>
             </div>
   </div>
   </div>
 }
</div>

@code {
    private IJsonStringLocalizer Q = default!;

    [Parameter]
    public Guid SessionId { get; set; }

    private QuizSessionWithQuestionsDto? _session;
    private bool _isLoading = true;
    private bool _isFinished = false;

    private int _currentQuestionIndex = 0;
    private QuizQuestionDto? _currentQuestion => _session?.Questions.ElementAtOrDefault(_currentQuestionIndex);

    private int? _selectedAnswerIndex = null;
    private bool _answerSubmitted = false;
    private bool _isSubmitting = false;
    private bool _lastAnswerCorrect = false;
    private string _feedbackMessage = string.Empty;

    private int _totalScore = 0;
    private int _correctAnswers = 0;
    private int _answeredCount = 0;

    private DateTime _questionStartTime;

    protected override void OnInitialized()
    {
 Q = L.Create("PlayQuiz");
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadQuizSession();
    }

    private async Task LoadQuizSession()
    {
        _isLoading = true;

        try
        {
            var query = new GetQuizSessionQuery { SessionId = SessionId };
            _session = await GetSessionHandler.HandleAsync(query);

     if (_session is null)
   {
   return;
            }

            if (_session.FinishedAt is not null)
{
    _isFinished = true;
        _totalScore = _session.Score;
   }

       _questionStartTime = DateTime.Now;
        }
        catch (Exception ex)
   {
            Console.WriteLine($"Error loading quiz: {ex.Message}");
        }
        finally
        {
         _isLoading = false;
  }
    }

    private void SelectAnswer(int index)
    {
        if (_answerSubmitted)
            return;

        _selectedAnswerIndex = index;
    _feedbackMessage = string.Empty;
    }

    private async Task SubmitAnswer()
    {
 if (_selectedAnswerIndex is null || _currentQuestion is null)
            return;

        _isSubmitting = true;
    _feedbackMessage = string.Empty;

      try
        {
            var timeSpent = (int)(DateTime.Now - _questionStartTime).TotalMilliseconds;

       var command = new SubmitAnswerCommand
            {
  QuestionId = _currentQuestion.Id,
   SelectedIndex = _selectedAnswerIndex.Value,
           TimeSpentMs = timeSpent
      };

    var result = await SubmitAnswerHandler.HandleAsync(command);

            _answerSubmitted = true;
          _lastAnswerCorrect = result.IsCorrect;
         _answeredCount++;

     if (result.IsCorrect)
            {
   _correctAnswers++;
            _totalScore += result.PointsEarned;
  _feedbackMessage = Q["CorrectAnswer"];
    }
            else
            {
       var correctOption = _currentQuestion.Options[result.CorrectIndex];
        _feedbackMessage = Q.Format("IncorrectAnswer", correctOption);
    }
        }
        catch (Exception ex)
        {
        _feedbackMessage = Q.Format("ErrorMessage", ex.Message);
        }
        finally
   {
            _isSubmitting = false;
        }
}

    private async Task NextQuestion()
    {
        if (_currentQuestionIndex < _session!.QuestionCount - 1)
        {
 // Move to next question
            _currentQuestionIndex++;
        _selectedAnswerIndex = null;
            _answerSubmitted = false;
 _feedbackMessage = string.Empty;
    _questionStartTime = DateTime.Now;
        }
  else
 {
            // Finish quiz
await FinishQuiz();
        }
}

  private async Task FinishQuiz()
    {
        try
        {
            var command = new FinishQuizCommand { SessionId = SessionId };
            var result = await FinishQuizHandler.HandleAsync(command);

            _totalScore = result.Score;
      _isFinished = true;
        }
        catch (Exception ex)
        {
            _feedbackMessage = Q.Format("ErrorFinishingQuiz", ex.Message);
        }
    }

    private string GetOptionButtonClass(int index)
    {
        if (!_answerSubmitted)
        {
    return _selectedAnswerIndex == index ? "active" : "";
        }

// After answer submitted, show correct/incorrect
      var correctClass = "list-group-item-success";
        var incorrectClass = "list-group-item-danger";

   if (_currentQuestion is not null)
        {
            // This requires knowing the correct answer - we'll need to fetch this from the server
   // For now, just highlight the selected answer
         return _selectedAnswerIndex == index ? 
         (_lastAnswerCorrect ? correctClass : incorrectClass) : "";
        }

        return "";
    }

    private string GetScoreColor()
    {
var percentage = GetScorePercentage();
        if (percentage >= 80) return "bg-success";
        if (percentage >= 60) return "bg-info";
        if (percentage >= 40) return "bg-warning";
        return "bg-danger";
    }

    private int GetScorePercentage()
    {
        if (_session is null || _session.QuestionCount == 0)
            return 0;

        return (int)((_totalScore * 100.0) / (_session.QuestionCount * 10));
    }
}
