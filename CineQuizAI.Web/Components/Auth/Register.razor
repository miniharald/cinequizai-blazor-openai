@page "/auth/register"

@using System.ComponentModel.DataAnnotations
@using System.Web
@using CineQuizAI.Web.Localization.JsonLocalization
@using CineQuizAI.Web.Components.Shared

@inject NavigationManager Nav
@inject IJsonStringLocalizerFactory L

<div class="auth-container">
    <div class="container py-5">
        <div class="row justify-content-center">
     <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 auth-card">
         <div class="card">
     <div class="card-body p-4 p-sm-5">
        <div class="text-center mb-4">
          <h2 class="card-title fw-bold">@R["CreateAccount"]</h2>
           <p class="text-secondary">@R["CreateAccount"]</p>
 </div>

                @if (!string.IsNullOrEmpty(_error))
      {
      <div class="alert alert-danger" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                   @_error
   </div>
            }

             <form method="post" action="/auth/register2">
<AppAntiforgeryToken />
        <input type="hidden" name="returnUrl" value="@_returnUrl" />
    
             <div class="mb-3">
 <label class="form-label">@R["Username"]</label>
 <input class="form-control form-control-lg" 
              name="userName" 
             value="@_model.UserName" 
               @oninput="e => _model.UserName = e.Value?.ToString() ?? string.Empty"
           placeholder="@R["Username"]" 
      required />
       </div>

    <div class="mb-3">
  <label class="form-label">@R["Email"]</label>
       <input class="form-control form-control-lg" 
     type="email" 
          name="email" 
      value="@_model.Email" 
       @oninput="e => _model.Email = e.Value?.ToString() ?? string.Empty"
  placeholder="@R["Email"]" 
     required />
     </div>

    <div class="mb-3">
      <label class="form-label">@S["Labels:Password"]</label>
         <input class="form-control form-control-lg" 
    type="password" 
             name="password" 
   value="@_model.Password" 
 @oninput="e => _model.Password = e.Value?.ToString() ?? string.Empty"
          placeholder="@S["Labels:Password"]" 
         required />
          </div>

<div class="mb-4">
    <label class="form-label">@R["ConfirmPassword"]</label>
  <input class="form-control form-control-lg" 
     type="password" 
   name="confirmPassword" 
      value="@_model.ConfirmPassword" 
       @oninput="e => _model.ConfirmPassword = e.Value?.ToString() ?? string.Empty"
    placeholder="@R["ConfirmPassword"]" 
   required />
        </div>

         <button class="btn btn-primary btn-lg w-100 mb-3" type="submit">
              @R["RegisterButton"]
        </button>
    </form>

         <div class="text-center">
      <p class="text-secondary mb-2">@R["AlreadyHaveAccount"]</p>
       <a href="/auth/login" class="btn btn-outline-secondary">
    @S["Labels:SignIn"]
       </a>
                </div>
    </div>
    </div>

      <p class="text-center mt-4">
            <a href="/" class="text-secondary">
            <i class="bi bi-arrow-left me-2"></i>@R["BackToHome"]
    </a>
      </p>
            </div>
        </div>
    </div>
</div>

@code {
  private IJsonStringLocalizer R = default!;
    private IJsonStringLocalizer S = default!;
    private string? _error;
    private string? _returnUrl;
    private RegisterModel _model = new();

    private class RegisterModel
    {
 public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override void OnInitialized()
    {
        R = L.Create("Register");
        S = L.Create("Shared");

        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        _returnUrl = query["ReturnUrl"];
        
        // Restore non-sensitive data from query string if present
      var userName = query["userName"];
        if (!string.IsNullOrEmpty(userName))
    _model.UserName = userName;
 
        var email = query["email"];
        if (!string.IsNullOrEmpty(email))
    _model.Email = email;
        
        var errorKey = query["error"];
        if (!string.IsNullOrEmpty(errorKey))
        {
            _error = R[errorKey] ?? S["Errors:UnexpectedError"];
  }
    }
}
