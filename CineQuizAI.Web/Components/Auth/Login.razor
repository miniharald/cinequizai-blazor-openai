@page "/auth/login"

@using System.ComponentModel.DataAnnotations
@using System.Net.Http;
@using System.Web;
@using Microsoft.AspNetCore.Components;
@using Microsoft.AspNetCore.Components.Web;
@using CineQuizAI.Web.Localization.JsonLocalization;
@using CineQuizAI.Web.Components.Shared;

@inject NavigationManager Nav
@inject IJsonStringLocalizerFactory L
@inject IHttpClientFactory HttpClientFactory

<div class="auth-container">
    <div class="container py-5">
    <div class="row justify-content-center">
   <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 auth-card">
       <div class="card">
         <div class="card-body p-4 p-sm-5">
     <div class="text-center mb-4">
                  <h2 class="card-title fw-bold">@T["SignIn"]</h2>
    <p class="text-secondary">@T["Welcome"]</p>
                </div>

       @if (!string.IsNullOrEmpty(_error))
          {
         <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
      @_error
             </div>
    }

       <form method="post" action="/auth/login2">
                 <AppAntiforgeryToken />
         <input type="hidden" name="returnUrl" value="@_returnUrl" />
         
<div class="mb-3">
             <label class="form-label">@T["UsernameOrEmail"]</label>
               <input class="form-control form-control-lg" 
               name="userNameOrEmail" 
     value="@_model.UserNameOrEmail" 
                      @oninput="e => _model.UserNameOrEmail = e.Value?.ToString() ?? string.Empty"
     placeholder="@T["UsernameOrEmail"]" 
             required />
   </div>
   
                 <div class="mb-4">
    <label class="form-label">@S["Labels:Password"]</label>
   <input class="form-control form-control-lg" 
                type="password" 
 name="password" 
         value="@_model.Password" 
          @oninput="e => _model.Password = e.Value?.ToString() ?? string.Empty"
  placeholder="@S["Labels:Password"]" 
          required />
        </div>
             
   <button class="btn btn-primary btn-lg w-100 mb-3" type="submit">
              @T["SignIn"]
    </button>
      </form>

  <div class="text-center">
  <p class="text-secondary mb-2">@T["NoAccount"]</p>
           <a href="/auth/register" class="btn btn-outline-secondary">
    @T["CreateAccount"]
             </a>
      </div>
         </div>
          </div>
    </div>
        </div>
    </div>
</div>

@code {
    private IJsonStringLocalizer T = default!;
    private IJsonStringLocalizer S = default!;
    private string? _error;
    private string? _returnUrl;
    private LoginVm _model = new();

    public class LoginVm
    {
        public string UserNameOrEmail { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

protected override void OnInitialized()
    {
        T = L.Create("Login");
     S = L.Create("Shared");
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _returnUrl = query["ReturnUrl"];
      var errorKey = query["error"];
if (!string.IsNullOrEmpty(errorKey))
        {
      if (errorKey == "InvalidCredentials")
    _error = T["InvalidCredentials"];
  else
                _error = S["Errors:UnexpectedError"];
  }
    }
}
